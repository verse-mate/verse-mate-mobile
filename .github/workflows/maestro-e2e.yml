name: Maestro E2E Tests

on:
  workflow_dispatch:
    inputs:
      test-folder:
        description: 'Specific test subfolder to run (e.g., swipe, auth, topics). Leave empty to run all tests.'
        required: false
        type: string
        default: ''
      force-rebuild:
        type: boolean
        default: false
        description: "Force fresh native build (ignore cache)"

jobs:
  maestro-e2e:
    name: Maestro E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Maestro CLI
        run: |
          curl -fsSL "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          # Verify installation
          $HOME/.maestro/bin/maestro --version

      - name: Enable KVM hardware acceleration
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Generate native fingerprint
        id: fingerprint
        run: |
          HASH=$(npx @expo/fingerprint fingerprint:generate --platform android | jq -r '.hash')
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Fingerprint hash: $HASH"

      - name: Cache APK
        id: apk-cache
        uses: actions/cache@v4
        with:
          path: app.apk
          key: e2e-apk-android-${{ steps.fingerprint.outputs.hash }}

      - name: Setup EAS CLI and build APK
        if: steps.apk-cache.outputs.cache-hit != 'true' || github.event.inputs.force-rebuild == 'true'
        id: eas_build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          npm install -g eas-cli

          echo "Triggering EAS e2e-test build for Android..."
          eas build --platform android --profile e2e-test --non-interactive --wait --json > build_output.json

          # Extract APK download URL from JSON output
          APK_URL=$(jq -r '.[0].artifacts.buildUrl' build_output.json)
          BUILD_ID=$(jq -r '.[0].id' build_output.json)

          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "Error: Failed to extract APK download URL"
            cat build_output.json
            exit 1
          fi

          echo "Build ID: $BUILD_ID"
          echo "APK URL: $APK_URL"

          # Download the APK
          curl -L -o app.apk "$APK_URL"

          echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "build_url=https://expo.dev/accounts/versemate/projects/verse-mate-mobile/builds/$BUILD_ID" >> $GITHUB_OUTPUT

      - name: Push JS update
        continue-on-error: true
        run: |
          npm install -g eas-cli
          eas update --branch e2e-test --message "CI update for ${{ github.sha }}"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Run phone tests on Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: pixel_6
          force-avd-creation: true
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: bash .github/scripts/run-phone-tests.sh "${{ github.event.inputs.test-folder }}"

      - name: Run split-view tests on Android tablet emulator
        if: success() || failure()
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: Nexus 10
          force-avd-creation: true
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -skin 2560x1600
          disable-animations: true
          script: bash .github/scripts/run-tablet-tests.sh "${{ github.event.inputs.test-folder }}"

      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-test-results
          path: ~/.maestro/tests/
          retention-days: 14

      - name: Capture emulator logcat
        if: failure()
        timeout-minutes: 1
        run: adb logcat -d > emulator-logcat.txt || true

      - name: Upload emulator logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logs
          path: emulator-logcat.txt
          retention-days: 14

      - name: Workflow summary
        if: always()
        run: |
          TEST_FOLDER="${{ github.event.inputs.test-folder }}"
          if [ -z "$TEST_FOLDER" ]; then
            TEST_TARGET="all test folders"
          else
            TEST_TARGET=".maestro/$TEST_FOLDER/"
          fi

          FINGERPRINT_HASH="${{ steps.fingerprint.outputs.hash }}"
          FORCE_REBUILD="${{ github.event.inputs.force-rebuild }}"
          CACHE_HIT="${{ steps.apk-cache.outputs.cache-hit }}"

          if [ "$CACHE_HIT" = "true" ] && [ "$FORCE_REBUILD" != "true" ]; then
            APK_SOURCE="Cached APK (fingerprint match)"
          else
            APK_SOURCE="Fresh EAS build"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Maestro E2E Test Results

          | Property | Value |
          |----------|-------|
          | **Test Target** | $TEST_TARGET |
          | **Android API Level** | 34 |
          | **Phone Emulator** | Pixel 6 (x86_64, google_apis) |
          | **Tablet Emulator** | Nexus 10 (2560x1600) |
          | **APK Source** | $APK_SOURCE |
          | **Fingerprint Hash** | \`$FINGERPRINT_HASH\` |
          | **Force Rebuild** | $FORCE_REBUILD |
          | **EAS Update Branch** | e2e-test |
          | **EAS Build ID** | \`${{ steps.eas_build.outputs.build_id }}\` |
          | **EAS Build URL** | ${{ steps.eas_build.outputs.build_url }} |

          ### APK Caching
          - **Cache key**: \`e2e-apk-android-$FINGERPRINT_HASH\`
          - **Cache hit**: $CACHE_HIT
          - **Force rebuild requested**: $FORCE_REBUILD
          - EAS Update pushed to branch \`e2e-test\` for commit \`${{ github.sha }}\`

          ### Test Execution
          - Phone tests ran all feature folders except \`split-view/\`
          - Split-view tests ran on a separate Nexus 10 tablet emulator in landscape
          - Warm launch performed before tests to pre-download EAS Update

          ### Artifacts
          - **maestro-test-results**: Maestro screenshots and test output
          - **emulator-logs**: Android logcat output (uploaded on failure only)
          EOF
